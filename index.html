<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Incontri - Parrocchia Maria Immacolata</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; --bg-color: #f4f7f6; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: var(--primary-color); margin-bottom: 25px; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 400; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
        button:hover { background-color: #2980b9; }
        #messaggio { margin-top: 15px; text-align: center; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="titoloPagina">Prenotazione Incontro</h2>
    <div id="selezioneCatechista" class="form-group" style="display:none;">
        <label id="labelRuolo" for="catechista">Seleziona:</label>
        <select id="catechista" onchange="caricaDate()"></select>
    </div>
    <div class="form-group">
        <label for="dataOra">Seleziona Data e Ora:</label>
        <select id="dataOra">
            <option value="">Caricamento date...</option>
        </select>
    </div>
    <div class="form-group">
        <label for="genitore">Nome e Cognome Genitore:</label>
        <input type="text" id="genitore" placeholder="Esempio: Mario Rossi">
    </div>
    <div class="form-group">
        <label for="figlio">Nome e Cognome Figlio/a:</label>
        <input type="text" id="figlio" placeholder="Esempio: Luigi Rossi">
    </div>
    <button onclick="inviaPrenotazione()">Conferma Prenotazione</button>
    <div id="messaggio"></div>
</div>

<script>
    // --- CONFIGURAZIONE ---
    const webAppUrl = "INCOLLA_QUI_IL_TUO_NUOVO_LINK_EXEC";

    const mappaturaCatechisti = {
        "Catechismo-3Â°Elementare-Blu": ["Attanasio Anna", "Iannotti Luigi e Mellone Francesca Pia"],
        "ACR-5/6/7": ["Grazia e Rosaria", "Antonia e Rosanna"]
    };

    const urlParams = new URLSearchParams(window.location.search);
    const gruppo = urlParams.get('gruppo') || "Catechismo";
    const classe = urlParams.get('classe');
    const diviso = urlParams.get('diviso');

    document.getElementById('titoloPagina').innerText = "Prenotazione " + gruppo + " - " + classe;
    document.getElementById('labelRuolo').innerText = (gruppo === "ACR") ? "Seleziona Educatore:" : "Seleziona Catechista:";

    if (diviso === 'si') {
        document.getElementById('selezioneCatechista').style.display = 'block';
        const selectCat = document.getElementById('catechista');
        mappaturaCatechisti[classe].forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat;
            opt.innerHTML = cat;
            selectCat.appendChild(opt);
        });
    }

    async function caricaDate() {
        const selectData = document.getElementById('dataOra');
        selectData.innerHTML = "<option>Caricamento...</option>";
        const catScelto = (diviso === 'si') ? document.getElementById('catechista').value : "";
        
        try {
            const response = await fetch(`${webAppUrl}?classe=${classe}`);
            const date = await response.json();
            selectData.innerHTML = "";
            const filtrate = date.filter(d => diviso !== 'si' || d.catechista === catScelto);
            
            if (filtrate.length === 0) {
                selectData.innerHTML = "<option value=''>Nessuna data disponibile</option>";
            } else {
                filtrate.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d.ora;
                    opt.innerHTML = `${d.data} - ore ${d.ora} (${d.luogo})`;
                    selectData.appendChild(opt);
                });
            }
        } catch (e) { selectData.innerHTML = "<option>Errore nel caricamento</option>"; }
    }

    async function inviaPrenotazione() {
        const oraScelta = document.getElementById('dataOra').value;
        const genitore = document.getElementById('genitore').value;
        const figlio = document.getElementById('figlio').value;
        const msgDiv = document.getElementById('messaggio');

        if (!oraScelta || !genitore || !figlio) { alert("Completa tutti i campi"); return; }
        
        msgDiv.innerText = "Invio in corso...";
        const params = new URLSearchParams({ classe, ora: oraScelta, genitore, figlio, gruppo });

        try {
            const response = await fetch(webAppUrl, { method: 'POST', body: params });
            const result = await response.text();
            if (result === "OK") {
                msgDiv.style.color = "green";
                msgDiv.innerText = "Prenotazione confermata! Riceverai un'email.";
                setTimeout(() => location.reload(), 3000);
            } else { throw new Error(); }
        } catch (e) {
            msgDiv.style.color = "red";
            msgDiv.innerText = "Errore durante la prenotazione. Riprova.";
        }
    }

    caricaDate();
</script>
</body>
</html>